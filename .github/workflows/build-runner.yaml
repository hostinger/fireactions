---
name: build-runner

on:
  workflow_dispatch:
    inputs:
      version:
        required: true

permissions:
  packages: write
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-20.04", "ubuntu-22.04"]
        platform: ["linux/amd64", "linux/arm64"]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set platform name
      run: |
        if [ "${{ matrix.platform }}" == "linux/amd64" ]; then
          echo "PLATFORM=x64" >> $GITHUB_ENV
        elif [ "${{ matrix.platform }}" == "linux/arm64" ]; then
          echo "PLATFORM=arm64" >> $GITHUB_ENV
        fi

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        provenance: false
        context: contrib
        file: contrib/${{ matrix.os }}.Dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ghcr.io/${{ github.repository }}/runner:${{ matrix.os }}-${{ env.PLATFORM }}-${{ github.event.inputs.version }},
          ghcr.io/${{ github.repository }}/runner:${{ matrix.os }}-${{ env.PLATFORM }}
        platforms: ${{ matrix.platform }}
        build-args: |
          TARGETPLATFORM=${{ matrix.platform }}
          RUNNER_VERSION=${{ github.event.inputs.version }}
