---
name: build-kernel

on:
  workflow_dispatch:
    inputs:
      version:
        description: Kernel version to build
        required: true
        default: '5.10'
      arch:
        description: Architecture
        required: true
        type: choice
        default: 'x86_64'
        options:
        - x86_64
        - arm64

permissions:
  packages: write
  contents: write

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/konradasb/docker-kernel-build:e89c0048a44398df9e63081c20c2ffbdea06dae6
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: fireactions

    - name: Build Linux kernel
      run: |
        git clone --branch v${{ inputs.version }} --single-branch --depth 1 git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git linux
        cp contrib/kernels/kernel-${{ inputs.arch }}-${{ inputs.version }}.config linux/.config
        cd linux
        make ARCH=${{ inputs.arch }} -j$(nproc) vmlinux

    - name: Upload Linux kernel to GCS
      uses: google-github-actions/upload-cloud-storage@v1
      with:
        destination: fireactions/kernels/${{ inputs.arch }}/${{ inputs.version }}
        process_gcloudignore: false
        path: linux/vmlinux
